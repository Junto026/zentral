name: Build & Publish Zentral to GHCR

on:
  workflow_dispatch:
  schedule:
    - cron: "0 1 * * *"   # daily at 07:35 UTC; adjust as desired

# Keep default token minimal; the job will request only what it needs.
permissions:
  contents: read
  packages: write

env:
  # Where your images will be published
  GHCR_IMAGE: ghcr.io/junto026/zentral
  # Upstream repo to track
  UPSTREAM: zentralopensource/zentral
  # Target image for zentral SCEP Server
  GHCR_IMAGE_SCEP: ghcr.io/junto026/zentral-scepserver

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Ensure jq is available
        run: |
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y jq
          fi
          
      - name: Determine latest upstream tag
        id: latest
        run: |
          set -euo pipefail
          TAG=$(
            git ls-remote --tags "https://github.com/${UPSTREAM}.git" \
            | awk '{print $2}' \
            | sed -n 's#refs/tags/##p' \
            | sed 's/\^{}$//' \
            | grep -E '^v[0-9]+\.[0-9]+(\.[0-9]+)?$' \
            | sort -V | tail -1
          )
          if [ -z "${TAG:-}" ]; then
            echo "Could not determine latest stable tag" >&2
            exit 1
          fi
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "Latest upstream tag: $TAG"

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Skip if this tag already exists in GHCR
        id: exist
        continue-on-error: true
        run: docker manifest inspect "${GHCR_IMAGE}:${{ steps.latest.outputs.tag }}"

      - name: Checkout upstream source at that tag
        if: steps.exist.outcome != 'success'
        uses: actions/checkout@v4
        with:
          repository: ${{ env.UPSTREAM }}
          ref: ${{ steps.latest.outputs.tag }}

      - name: Set up Buildx
        if: steps.exist.outcome != 'success'
        uses: docker/setup-buildx-action@v3

      - name: Build & push image
        if: steps.exist.outcome != 'success'
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          platforms: linux/amd64
          tags: |
            ${{ env.GHCR_IMAGE }}:${{ steps.latest.outputs.tag }}
            ${{ env.GHCR_IMAGE }}:latest
          provenance: false
  build-scepserver:
    name: Build & push scepserver
    runs-on: ubuntu-latest
  
    permissions:
      contents: read
      packages: write
  
    steps:
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
  
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
  
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine latest upstream tag
        id: latest
        run: |
          set -euo pipefail
          TAG=$(
            git ls-remote --tags "https://github.com/zentralopensource/zentral.git" \
            | awk '{print $2}' \
            | sed -n 's#refs/tags/##p' \
            | sed 's/\^{}$//' \
            | grep -E '^v[0-9]+\.[0-9]+(\.[0-9]+)?$' \
            | sort -V | tail -1
          )
          if [ -z "${TAG:-}" ]; then
            echo "Could not determine latest stable tag" >&2
            exit 1
          fi
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "Latest upstream tag: $TAG"

  
      - name: Compute tags
        id: meta
        run: |
          IMAGE="${{ env.GHCR_IMAGE_SCEP }}"
          TAGS="${IMAGE}:${{ steps.latest.outputs.tag }},${IMAGE}:latest"
          echo "image=${IMAGE}" >> $GITHUB_OUTPUT
          echo "tags=${TAGS}" >> $GITHUB_OUTPUT

      - name: Skip if this SCEP tag already exists in GHCR
        id: scep_exist
        continue-on-error: true
        run: docker manifest inspect "${{ env.GHCR_IMAGE_SCEP }}:${{ steps.latest.outputs.tag }}"
  
      - name: Build & push from upstream Zentral (scepserver)
        if: steps.scep_exist.outcome != 'success'
        uses: docker/build-push-action@v6
        with:
          # Use the upstream tag, not main
          context: https://github.com/zentralopensource/zentral.git#${{ steps.latest.outputs.tag }}:conf/common/docker/scepserver
          file: Dockerfile
          push: true
          platforms: linux/amd64
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=registry,ref=${{ steps.meta.outputs.image }}:buildcache
          cache-to: type=registry,ref=${{ steps.meta.outputs.image }}:buildcache,mode=max
